#!/bin/bash

# Source YunoHost helpers
source /usr/share/yunohost/helpers

# Stop script if errors
ynh_abort_if_errors

# Import common cmd
source ../settings/scripts/_common.sh

# Init get Final path
get_configuration

# Retrieve arguments
domain=$(ynh_app_setting_get $app domain)
path=$(ynh_normalize_url_path $(ynh_app_setting_get $app path))
db_pwd=$(ynh_app_setting_get ${app} mysqlpwd)
final_path=/var/www/$app
seafile_user=www-data

# Check domain/path availability
ynh_webpath_available $domain $path || ynh_die "$domain/$path is not available, please use an other domain or path."

# Restore dependencies
install_dependance

# Restore all config and data
ynh_restore

# Restore mysql dump
dbuser=seafile
ynh_mysql_create_db ccnetdb "$dbuser" "$db_pwd"
ynh_mysql_create_db seafiledb "$dbuser" "$db_pwd"
ynh_mysql_create_db seahubdb "$dbuser" "$db_pwd"
su -c "mysql -u ${app} -p$db_pwd ccnetdb < ${YNH_CWD}/ccnetdb.dmp"
su -c "mysql -u ${app} -p$db_pwd seafiledb < ${YNH_CWD}/seafiledb.dmp"
su -c "mysql -u ${app} -p$db_pwd seahubdb < ${YNH_CWD}/seahubdb.dmp"

# Restore sso persistent config
python $final_path/add_sso_conf.py

# Add logrotate
ynh_use_logrotate $final_path/logs/seaf-server.log
ynh_use_logrotate $final_path/logs/ccnet.log

# Add Seafile to YunoHost's monitored services
yunohost service add seafile-server

# Reload nginx
systemctl reload nginx.service

# Enable service and start seafile
systemctl daemon-reload
update-rc.d seafile-server defaults
systemctl start seafile-server.service
